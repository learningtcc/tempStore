package com.ks.logic.service.impl;

import java.util.ArrayList;
import java.util.List;

import com.ks.exceptions.GameException;
import com.ks.logic.cache.GameCache;
import com.ks.logic.service.BaseService;
import com.ks.logic.service.UserAchieveService;
import com.ks.model.achieve.Achieve;
import com.ks.model.achieve.AchieveAward;
import com.ks.model.achieve.UserAchieve;
import com.ks.model.goods.Backage;
import com.ks.model.goods.Goods;
import com.ks.model.goods.UserBakProp;
import com.ks.model.logger.LoggerType;
import com.ks.model.user.User;
import com.ks.model.user.UserSoul;
import com.ks.model.user.UserStat;
import com.ks.protocol.MessageFactory;
import com.ks.protocol.vo.achieve.AchieveAwardVO;
import com.ks.protocol.vo.achieve.UserAchieveVO;
import com.ks.protocol.vo.goods.UserBakPropVO;
import com.ks.protocol.vo.goods.UserGoodsVO;
import com.ks.protocol.vo.user.UserSoulVO;

public class UserAchieveServiceImpl extends BaseService implements
		UserAchieveService {

	@Override
	public List<Achieve> getAchieveRule() {
		return achieveCfgDAO.getAchieveRule();
	}

	@Override
	public List<AchieveAward> getAllAchieveAward() {
		return achieveCfgDAO.getAllAchieveAward();
	}

	@Override
	public List<UserAchieveVO> queryUserAchieve(int userId) {
		List<UserAchieve> list = achieveDAO.queryUserAchieve(userId);
		List<UserAchieveVO> vos = new ArrayList<>();
		for (UserAchieve a : list) {
			UserAchieveVO vo = MessageFactory.getMessage(UserAchieveVO.class);
			vo.init(a);
			vos.add(vo);
		}
		return vos;
	}

	@Override
	public void addUserAchieveBatch(int userId, List<UserAchieve> mapList) {
		achieveDAO.addUserAchieveBatch(userId, mapList);
	}

	@Override
	public void addUserAchieveProcess(int userId, int type, int assId, int num) {
		UserAchieve achieve = achieveDAO.queryUserMaxAchieve(userId, type,assId);
		List<UserAchieve> addAchieves = new ArrayList<>();
		List<Achieve> defines = GameCache.ACHIEVE_MAP.get(type);
		// 存在 没有完成本个目标
		if (achieve == null) {
			for (Achieve define : defines) {
				if (define.getAssId() != assId || define.getType() != type) {
					continue;
				}
				if (num >= define.getNum()) {
					addAchieves.add(UserAchieve.create(userId,
							define.getAchieveId(), define.getType(), define.getAssId(),
							define.getNum(), define.getNum(), UserAchieve.STATE_已达成));
				} else if (define.getNum() > num) {
					//用户等级是从1级开始(新的任务要加1)
					if(type==Achieve.TYPE_用户等级){
						num+=1;
					}
					addAchieves.add(UserAchieve.create(userId,
							define.getAchieveId(), define.getType(), define.getAssId(), num,
							define.getNum(), UserAchieve.STATE_未达成));
					break;
				}
			}
		} else if (achieve.getCurrentNum() + num < achieve.getTotalNum()) {
			achieve.setCurrentNum(achieve.getCurrentNum()+num);
			achieveDAO.updateUserAchieve(achieve);
			
		} else if (achieve.getCurrentNum() + num >= achieve.getTotalNum()) {
			// 完成当前的
			int current = achieve.getCurrentNum() + num;
			takeAchieve(userId, achieve.getAchieveId());
			for (Achieve define : defines) {
				if (define.getAssId() != assId || define.getType() != type) {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
					continue;
				}
				// 查找已经达成的
				if (current >= define.getNum() 
					&& define.getNum() > achieve.getTotalNum()){
					//已经达成的就不要再重复更新
					addAchieves.add(UserAchieve.create(userId,
							define.getAchieveId(), define.getType(), define.getAssId(),
							define.getNum(), define.getNum(), UserAchieve.STATE_已达成));
				} else if (current<define.getNum()) {
					// 找到最后一个大于当前条件的成就
					addAchieves.add(UserAchieve.create(userId,
							define.getAchieveId(), define.getType(), define.getAssId(),
							current, define.getNum(), UserAchieve.STATE_未达成));
					break;
				}
			}
		}
		if (!addAchieves.isEmpty()) {
			achieveDAO.addUserAchieveBatch(userId, addAchieves);
		}
	}

	@Override
	public void takeAchieve(int userId, int achieveId) {
		UserAchieve userAchieve = achieveDAO
				.queryUserAchieve(userId, achieveId);
		if (userAchieve == null) {
			throw new GameException(GameException.CODE_成就不存在,
					"user achieve not found." + achieveId);
		}
		if (userAchieve.getState() == UserAchieve.STATE_已达成
				||userAchieve.getState()==UserAchieve.STATE_已领取) {
			return;
		}
		userAchieve.setCurrentNum(userAchieve.getTotalNum());
		userAchieve.setState(UserAchieve.STATE_已达成);
		achieveDAO.updateUserAchieve(userAchieve);
	}

	@Override
	public AchieveAwardVO getAchieveAward(int userId, int achieveId) {
		UserAchieve userAchieve = achieveDAO.queryUserAchieve(userId, achieveId);
		
		if (userAchieve == null) {
			throw new GameException(GameException.CODE_成就不存在, "user achieve not found." + achieveId);
		} else if (userAchieve.getState() != UserAchieve.STATE_已达成) {
			throw new GameException(GameException.CODE_成就奖励已领取, " has get award." + achieveId);
		}
		
		List<AchieveAward> awards = GameCache.ACHIEVE_AWARDS.get(achieveId);
		User user = userService.getExistUserCache(userId);
		List<Goods> itemGoods = new ArrayList<Goods>();
		List<UserGoodsVO> giveGoos = new ArrayList<>();
		List<UserSoulVO> soulVos = new ArrayList<>();
		List<UserBakPropVO> bakProps=new ArrayList<UserBakPropVO>();
		for (AchieveAward award : awards) {
			Goods goods = Goods.create( award.getAssId(), award.getType(),award.getNum(), 1);

			switch (award.getType()) {
			case Goods.TYPE_PROP:
			case Goods.TYPE_STUFF:
			case Goods.TYPE_EQUIPMENT:
				itemGoods.add(goods);
				break;
			case Goods.TYPE_GOLD:
				userService.incrementGold(user, goods.getNum(), LoggerType.TYPE_成就奖励, "");
				break;
			case Goods.TYPE_CURRENCY:
				userService.incrementCurrency(user, goods.getNum(), LoggerType.TYPE_成就奖励, "");
				break;
			case Goods.TYPE_FRIENDLY_POINT:
				userService.incrementFriendlyPoint(user.getUserId(), goods.getNum(), LoggerType.TYPE_成就奖励, "");
				break;
			case Goods.TYPE_SOUL:
				userSoulService.checkSoulFull(user);
				for(int i=1; i<=goods.getNum(); i++){
					UserSoul soul = userSoulService.addUserSoul(user,goods.getGoodsId(), goods.getLevel(),LoggerType.TYPE_成就奖励);
					UserSoulVO soulVo = MessageFactory.getMessage(UserSoulVO.class);
					soulVo.init(soul);
					soulVos.add(soulVo);
				}
				break;
			case Goods.TYPE_BAK_PROP:
				userGoodsService.addBakProps(user, goods.getGoodsId(), goods.getNum(), LoggerType.TYPE_成就奖励,"");
				UserBakProp prop=UserBakProp.create(user.getUserId(), goods.getGoodsId(), goods.getNum());
				UserBakPropVO propVo=MessageFactory.getMessage(UserBakPropVO.class);
				propVo.init(prop);
				bakProps.add(propVo);
			default:
				break;
			}
		}
		
		if (itemGoods.size() != 0) {
			Backage backage = userGoodsService.getPackage(userId);
			userGoodsService.checkBackageFull(backage, user);
			List<UserGoodsVO> gvos = userGoodsService.addGoods(user, backage, itemGoods, LoggerType.TYPE_成就奖励, "");
			giveGoos.addAll(gvos);
		}
		
		userAchieve.setState(UserAchieve.STATE_已领取);
		achieveDAO.updateUserAchieve(userAchieve);

		AchieveAwardVO awardVo = MessageFactory.getMessage(AchieveAwardVO.class);
		// 奖励
		UserStat stat = userStatDAO.queryUserStat(userId);
		awardVo.setFriendlyPoint(stat.getFriendlyPoint());
		awardVo.setCurrency(user.getCurrency());
		awardVo.setGold(user.getGold());
		awardVo.setGoods(giveGoos);
		awardVo.setUserSouls(soulVos);
		awardVo.setBakProps(bakProps);
		return awardVo;
	}

}
